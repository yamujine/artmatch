{% extends "base.twig" %}

{% block style %}
  <link rel="stylesheet" type="text/css" href="/static/dist/magnific-popup/magnific-popup.css">
  <link rel="stylesheet" type="text/css" href="/static/dist/slick/slick.css">
  <link rel="stylesheet" type="text/css" href="/static/dist/css/artworks/detail.min.css">
{% endblock %}

{% block script %}
  <script type="text/javascript" src="/static/dist/magnific-popup/jquery.magnific-popup.min.js"></script>
  <script type="text/javascript" src="/static/dist/slick/slick.min.js"></script>
  <script type="text/javascript">
    $(function () {
      // 메인 모든 사이즈의 이미지 형태에 대응하기 위함
      var mainImageWidth = $('.mainImage .image img').width();
      $('.mainImage').css({width: mainImageWidth});

      // 추가 이미지 Carousel 구현은 6개가 넘어갈 경우
      var additionalImageCount = $('.additionalImages .slider div').length;
      if (additionalImageCount > 6) {
        // Carousel 시작
        $('.slider').slick({
          infinite: false,
          variableWidth: true,

          slidesToShow: 6,
          slidesToScroll: 1,

          prevArrow: false,
          nextArrow: false
        });

        // 슬라이더 컨트롤
        $('.sliderPrevBtn').click(function () {
          $('.slider').slick('slickPrev');

          return false;
        });

        $('.sliderNextBtn').click(function () {
          $('.slider').slick('slickNext');

          return false;
        });
      }

      // 이미지 전체 보기
      $('.popupImage').magnificPopup({
        type: 'image',
        gallery: {
          enabled: true
        }
      });

      // 댓글
      $("#commentRegisterForm").submit(function () {
        var $this = $(this);

        $.ajax({
          method: "POST",
          url: "/api/comments/insert",
          data: {
            type: $this.find("input[name=type]").val(),
            type_id: $this.find("input[name=type_id]").val(),
            comment: $this.find("textarea[name=comment]").val()
          }
        })
          .done(function (data) {
            if (!data.result) {
              alert("댓글 등록 실패");
              return false;
            }

            var user_img = "";
            if(data.body.comment.profile_image) {
              user_img = "{{ user_img | thumb_url("profile") }}";
            } else {
              user_img = "/static/images/tom.jpg";
            }

            $('#comment_sample').clone().appendTo($('.comments'));
            $('.comments').find('#comment_sample').attr('id', 'comment_'+data.body.comment.id).css('display', '')
              .find('img').attr('src', user_img)
              .end().find('a').attr('href', '/users/'+data.body.comment.user_name).text(data.body.comment.user_name)
              .end().find('.regDate').html(" {{ user_date | date('y.m.d') }}")
            //TODO: twig 함수 처리 .end().find('.comment').html("{{ user_comment | nl2br }}");
              .end().find('.comment').html(data.body.comment.comment)
              .end().find('.commentEditBtn').attr('data-id', data.body.comment.id)
              .end().find('.commentDeleteBtn').attr({'data-type': data.body.type, 'data-type-id': data.body.type_id, 'data-id': data.body.comment.id })
              .end().find('#commentEditDiv').attr('id', 'commentEditDiv_'+data.body.comment.id)
              .find('.commentEditSubmit').attr({'data-type': data.body.type, 'data-id': data.body.comment.id });
            $this.find('textarea[name=comment]').val('');
            $('.commentArea').children().find('.number').text(data.body.comment_count);
          })
          .fail(function (data) {
            alert(data.body.message);
          });
        return false;
      });

      // 댓글 수정
      $(document).on('click', '.commentEditBtn', function () {
        var comment_id = $(this).data("id");
        var comment = $(this).closest("div").find(".comment").text();
        $('#commentEditDiv_' + comment_id).css("display", "");
        $('#commentEditDiv_' + comment_id).find('#commentEditText').val(comment);
        $('#comment_' + comment_id).find('.comment').text('');
        $('#comment_' + comment_id).find('.commentEditBtnCancel').css('display', '');
        $(this).css('display', 'none');

        $('#comment_' + comment_id).find('.commentEditBtnCancel').click(function () {
          $('#commentEditDiv_' + comment_id).css("display", "none");
          $('#comment_' + comment_id).find('.comment').text(comment);
          $('#comment_' + comment_id).find('.commentEditBtn').css('display', '');
          $(this).css('display', 'none');
        });

        $(document).on('click', '.commentEditSubmit', function () {
          var comment = $('#commentEditDiv_' + comment_id).find('#commentEditText').val();

          $.ajax({
            method: "POST",
            url: "/api/comments/update",
            data: {
              type: $(this).data('type'),
              type_comment_id: comment_id,
              comment: comment
            }
          }).done(function (data) {
            if (data.body.result_type === 'update') {
              $('#commentEditDiv_' + comment_id).css("display", "none");
              $('#comment_' + comment_id).find('.commentEditBtnCancel').css('display', 'none');
              $('#comment_' + comment_id).find('.commentEditBtn').css('display', '');
              $('#comment_' + comment_id).find('.comment').text(data.body.comment);
            } else {
              alert(data.body.message);
            }
          }).fail(function () {
            alert('서버에 문제가 있어 정상적으로 처리되지 않았습니다. \r\n잠시 후에 다시 시도해주세요.');
          });
        });
        return false;
      });


      // 댓글 삭제
      $(document).on('click', '.commentDeleteBtn', function () {
        var $this = $(this);
        $.ajax({
          method: "POST",
          url: "/api/comments/delete",
          data: {
            type: $this.data('type'),
            type_id: $this.data('type-id'),
            type_comment_id: $this.data('id')
          }
        }).done(function (data) {
          if (data.body.result_type === 'delete') {
            $('#comment_'+data.body.type_comment_id).remove();
            $('.commentArea').children().find('.number').text(data.body.comment_count);
          } else {
            alert(data.body.message);
          }
        }).fail(function () {
          alert('서버에 문제가 있어 정상적으로 처리되지 않았습니다. \r\n잠시 후에 다시 시도해주세요.');
        });
        return false;
      });

      // PICK
      $('.pickBtn').click(function () {
        var $this = $(this);
        var number = parseInt($(this).find('.number').html(), 10);

        $.ajax({
          method: "POST",
          url: "/api/pick",
          data: {
            type: $this.data('type'),
            type_id: $this.data('id')
          }
        })
          .done(function (data) {
            if (data.body.result_type === 'on') {
              $this.addClass('active').find('.number').html(data.body.pick_count);
            } else if (data.body.result_type === 'off') {
              $this.removeClass('active').find('.number').html(data.body.pick_count);
            } else {
              alert(data.body.message);
            }
          })
          .fail(function () {
            alert('서버에 문제가 있어 정상적으로 처리되지 않았습니다. \r\n잠시 후에 다시 시도해주세요.');
          });
        return false;
      });
    });
  </script>
{% endblock %}

{% block contents %}
  <div id="patDetail">
    <div class="container">
      <!-- == 제목 -->
      <div class="meta">
        <!-- == 제목 -->
        <div class="title">
          {{ artwork.title }}
        </div>
        <!-- == 작가 -->
        <div class="name">
          {{ artwork.user.user_name }}
        </div>
      </div>
      <!-- //== 제목 -->
      <!-- == 작품 -->
      <div class="artworks">
        <div class="mainThumbnail">
          <!-- == 메인 이미지 -->
          <div class="mainImage">
            <div class="image popupImage" data-mfp-src="{{ artwork.image | image_url }}">
              <div class="dimm"></div>
              <div class="preview">
                미리 보기 <i class="glyphicon glyphicon-menu-right"></i>
              </div>
              <img src="{{ artwork.image | thumb_url() }}"/>
            </div>
          </div>
          <!-- //== -->
          <!-- == 저작권 -->
          <div class="copyright">
            Copyright &copy; {{ artwork.user.user_name }} All right reserved. 작품 이미지의 도용 및 무단 재배포를 금합니다.
          </div>
          <!-- //== -->
        </div>
        {% if artwork.extra_images|length > 0 %}
          <div class="additionalImages">
            <div class="slider{% if artwork.extra_images|length <= 6 %} deactivate{% endif %}">
              {# data-mfp-src 에 (원본 이미지 URL) 하위 img src 에는 썸네일용 이미지 src를 설정 #}
              {% for extra in artwork.extra_images %}
                <div class="item">
                  <div class="imgThumbnail popupImage" data-mfp-src="{{ extra.image | image_url }}">
                    <div class="dimm"></div>
                    <div class="preview">미리 보기</div>
                    <img src="{{ extra.image | thumb_url }}"/>
                  </div>
                </div>
              {% endfor %}
            </div>
            {% if artwork.extra_images|length > 6 %}
              <button class="sliderPrevBtn"></button>
              <button class="sliderNextBtn"></button>
            {% endif %}
          </div>
        {% endif %}
      </div>
      <!-- //== 작품 -->
      <!-- == 작가의 한마디 -->
      <div class="artistCommentary">
        <div class="meta">
          <div class="artistProfileImage">
            {% if artwork.user.profile_image is empty %}
              <img src="/static/images/tom.jpg" class="img-circle"/>
            {% else %}
              <img src="{{ artwork.user.profile_image | thumb_url('profile') }}" class="img-circle"/>
            {% endif %}
          </div>
          <div class="artistSays">작가님의 한마디</div>
          <ul class="status">
            {% if artwork.is_now_exhibiting %}
              <li class="exhibition display">현재 전시중</li>
            {% elseif artwork.status == ARTWORK_STATUS_NEED_SPACE %}
              <li class="exhibition">전시공간 구함</li>
            {% endif %}
            {% if artwork.for_sale == ARTWORK_FOR_SALE %}
              <li class="buy">구매가능</li>
            {% endif %}
            {#
            <li class="exhibition_available_count">
              17.02.20 ~ 17.03.20까지 12 개의 작품 전시중
            </li>
            #}
          </ul>
        </div>
        <div class="commentary">
          {{ artwork.description|nl2br }}
        </div>
        <div class="tags">
          {{ artwork.tags_html|raw }}
        </div>
        <div class="pick">
          <button class="pickBtn{% if is_pick %} active{% endif %}" data-type="{{ TYPE_ARTWORKS }}" data-id="{{ artwork.id }}">
            PICK <span class="number">{{ artwork.pick_count }}</span>
          </button>
        </div>
      </div>
      <!-- //== 작가의 한마디 -->

      {% if artwork.use_comment == 1 %}
        <!-- == 댓글 -->
        <div class="commentArea">
          <div class="title">댓글 <span class="number">{{ comment_count }}</span></div>
          <hr class="divider"/>
          <div class="commentMore">
            <button class="commentMoreBtn">
              이전 댓글 더보기 <i class="glyphicon glyphicon-menu-down"></i>
            </button>
          </div>
          <ul class="comments">
            {% for comment in comments %}
              <li id="comment_{{ comment.id }}">
                <div class="profileImage">
                  {% if comment.profile_image is empty %}
                    <img src="/static/images/tom.jpg" class="img-circle"/>
                  {% else %}
                    <img src="{{ comment.profile_image | thumb_url('profile') }}" class="img-circle"/>
                  {% endif %}
                </div>
                <div class="content">
                  <div class="meta">
                    <a href="/users/{{ comment.user_name }}">{{ comment.user_name }}</a> <span class="regDate">{{ comment.posted_at|date('y.m.d') }}</span>
                  </div>
                  <div class="comment">{{ comment.comment|nl2br }}</div>
                  <button class="commentEditBtn" data-id="{{ comment.id }}">수정</button>
                  <button class="commentEditBtnCancel" style="display:none">수정취소</button>
                  <button class="commentDeleteBtn" data-type="{{ TYPE_ARTWORKS }}" data-type-id="{{ artwork.id }}" data-id="{{ comment.id }}">삭제</button>
                  <!-- == 댓글 수정 폼 -->
                  <div id="commentEditDiv_{{ comment.id }}" style="display:none">
                    <textarea id="commentEditText"></textarea>
                    <button class="commentEditSubmit" data-type="{{ TYPE_ARTWORKS }}" data-id="{{ comment.id }}">
                      저장
                    </button>
                  </div>
                  <!-- //== 댓글 수정 폼-->
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
        <!-- //== 댓글 -->

        <!-- == 댓글 샘플 -->
        <li id="comment_sample" style="display:none">
          <div class="profileImage">
            <img src="" class="img-circle"/>
          </div>
          <div class="content">
            <div class="meta">
              <a href=""></a> <span class="regDate"></span>
            </div>
            <div class="comment"></div>
            <button class="commentEditBtn" data-id="">수정</button>
            <button class="commentEditBtnCancel" style="display:none">수정취소</button>
            <button class="commentDeleteBtn" data-type="" data-type-id="" data-id="">삭제</button>
            <div id="commentEditDiv" style="display:none">
              <textarea id="commentEditText"></textarea>
              <button class="commentEditSubmit" data-type="" data-id="">
                저장
              </button>
            </div>
          </div>
        </li>
        <!-- //== 댓글 샘플 끝-->

        <!-- == 댓글 입력 -->
        <form id="commentRegisterForm" class="commentForm">
          <input type="hidden" name="type" placeholder="" value="{{ TYPE_ARTWORKS }}">
          <input type="hidden" name="type_id" placeholder="" value="{{ artwork.id }}">
          <textarea class="commentInput" name="comment" placeholder="작품에 대한 댓글을 남겨보세요."></textarea>
          <button type="submit">확인</button>
        </form>

        <!-- //== 댓글 입력 -->
      {% endif %}
      {% if exhibitions|length > 0 %}
        <!-- == 전시 이력 -->
        <div class="exhibitionArea">
          <div class="titleWrap">
            <div class="title">전시했던 장소</div>
            <ul class="sliderControl">
              <li class="active"><a href="#">01</a></li>
              <li><a href="#">02</a></li>
            </ul>
          </div>
          <ul class="exhibitions">
            {% for exhibition in exhibitions %}
              <li>
                <a href="/places/{{ exhibition.place_id }}">
                  <div class="imgThumbnail">
                    <img src="{{ exhibition.place.image | thumb_url }}"/>
                  </div>
                  <div class="meta">
                    <div class="name">
                      {{ exhibition.place.name|length > 12 ? exhibition.place.name|slice(0, 12) ~ '...' : exhibition.place.name  }}
                    </div>
                    <div class="place">
                      <div class="pin"></div>
                      <div class="keyword">{{ exhibition.place.area }}</div>
                    </div>
                    <div class="date">
                      {{ exhibition.start_date|date('y.m.d') }} ~ {{ exhibition.end_date|date('y.m.d') }}
                    </div>
                  </div>
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>
        <!-- //== 전시 이력 -->
      {% endif %}
    </div>
  </div>
{% endblock %}
