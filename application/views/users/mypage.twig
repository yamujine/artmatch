{% extends "base.twig" %}

{% block style %}
  <link rel="stylesheet" type="text/css" href="/static/dist/css/users/mypage.min.css">
{% endblock %}

{% block script %}
  <script type="text/javascript">
    $(function () {
      // 그리드 아이템 클릭
      $(document).on('click', '.item .wrap', function () {
        var type = $(this).data('type');
        var id = $(this).data('id');

        location.href = '/' + type + '/' + id;

        return false;
      })
        // 카드 클릭 이벤트와 안겹치도록 이벤트 버블링 방지
        .on('click', '.grid .wrap a', function (event) {
          event.stopPropagation();
        });

      // 비밀번호 변경
      $('#password_change_form').submit(function () {
        var currentPasswordElem = $("input[name=current_password]");
        var newPasswordElem = $("input[name=new_password]");

        if (!currentPasswordElem.val()) {
          alert('기존 비밀번호를 입력해 주세요');
          currentPasswordElem.focus();
          return false;
        }

        if (!newPasswordElem.val()) {
          alert('새로운 비밀번호를 입력해 주세요');
          newPasswordElem.focus();
          return false;
        }

        data = {};
        data.current_password = currentPasswordElem.val();
        data.new_password = newPasswordElem.val();

        $.ajax({
          method: "POST",
          url: "/api/users/change_password",
          data: data
        }).done(function (data) {
          if (data.result === true) {
            alert('비밀번호가 성공적으로 변경되었습니다');
            $('#password_modal').modal('hide');
          } else {
            alert(data.body.message);
          }
        }).fail(function () {
          alert('서버에 문제가 있어 정상적으로 처리되지 않았습니다. \r\n잠시 후에 다시 시도해주세요.');
        });
        return false;
      });

      // 프로필 이미지 등록 변경
      $('input[type=file]').change(function () {
        if (!confirm('프로필 이미지를 변경하시겠습니까?')) {
          return false;
        }

        var $this = $(this);
        var imageElement = $this.closest('.profileImage').find('img');

        // 이미지 파일 업로드를 위한 FormData 생성
        var formData = new FormData();
        formData.append("profile_image", $this[0].files[0]);

        $.ajax({
          method: "POST",
          url: "/api/users/update_image",
          processData: false, // To send file
          contentType: false, // To send file
          data: formData
        })
          .done(function (data) {
            if (!data.result) {
              alert(data.body.message.message);

              return false;
            }
            location.reload(true);
          })
          .fail(function () {
            alert('서버에 문제가 있어 정상적으로 처리되지 않았습니다. \r\n잠시 후에 다시 시도해주세요.');
          });
      });
    });
  </script>
{% endblock %}

{% block contents %}
  <!-- == 프로필 -->
  <div id="patProfile">
    <!-- == 유저 정보 -->
    <div class="userInfo">
      {# 나의 페이지인 경우 수정 버튼 표시 #}
      {% if is_my_page %}
        <!-- == 유저 수정 버튼 -->
        <div class="editButtons">
          <button class="passwordEditBtn">비밀번호 변경</button>
        </div>
        <!-- //== 유저 수정 버튼 -->
      {% endif %}
      <!-- == 프로필 이미지 -->
      <div class="profileImage">
        {% if is_my_page %}
          <div class="dimm"></div>
          <div class="editBtn">
            <input type="file" name="profileImage"/>
          </div>
        {% endif %}
        {% if user.profile_image is empty %}
          <img src="{{ 'images/avatar@2x.png' | static_url }}" class="img-circle"/>
        {% else %}
          <img src="{{ user.profile_image | thumb_url('profile') }}" class="img-circle"/>
        {% endif %}
      </div>
      <!-- //== 프로필 이미지 -->
      <!-- == 유저 이름 -->
      <div class="name">{{ user.user_name }}</div>
      <!-- // == 유저 이름 -->
      <!-- == 유저 메타 정보 -->
      <ul class="metadata">
        {% if user.type == USER_TYPE_ARTIST %}
          <li class="artwork">작품수 <span class="number">{{ mine|length }}</span></li>
        {% elseif user.type == USER_TYPE_PLACE_OWNER %}
          <li class="place">공간수 <span class="number">{{ mine|length }}</span></li>
        {% endif %}
        <li class="pick">PICK <span class="number">{{ given_pick_count }}</span></li>
      </ul>
      <!-- //== 유저 메타 정보 -->
    </div>
    <!-- //== 유저 정보 -->
  </div>
  <!-- //== 프로필 -->

  {% if is_my_page %}
    <!-- == 탭 -->
    <div id="patTab">
      <ul class="selectTab">
        <li>
          <a {% if pick_type is null %}class="active"{% endif %} href="/users/me">
            {% if user.type == USER_TYPE_ARTIST %}
              WORK
            {% elseif user.type == USER_TYPE_PLACE_OWNER %}
              SPACE
            {% endif %}
          </a>
        </li>
        <li>
          <a {% if pick_type is not null %}class="active"{% endif %} href="?type=artworks">PICK</a>
        </li>
      </ul>
      <div class="divider"></div>
    </div>
    <!-- //== 탭 -->
    {% if pick_type is not null %}
      <!-- == 픽 탭 -->
      <div id="pickTab">
        <div class="pickTypeButtons">
          <a class="{% if pick_type == TYPE_ARTWORKS %}active{% endif %}" href="?type=artworks">작품</a>
          <a class="{% if pick_type == TYPE_PLACES %}active{% endif %}" href="?type=places">공간</a>
        </div>
      </div>
      <!-- //== 픽 탭 -->
    {% endif %}
  {% endif %}
  
  {% if not is_my_page or (is_my_page and pick_type is empty) %}
    {% set items = mine %}
  {% else %}
    {% set items = my_picks %}
  {% endif %}

  {% if items|length > 0 %}
    <!-- == 작품 또는 장소 아이템 -->
    <div class="patItemList">
      <div class="container">
        <!-- == 아이템 목록 -->
        <ul class="itemList">
          {% import 'macro/mypage.macro.twig' as mypage_macro %}
          {% for item in items %}
            {% if not is_my_page or (is_my_page and pick_type is empty) %}
              {# 마이페이지 내 나의 작품/장소 #}
              {% if user.type == USER_TYPE_ARTIST %}
                {{ mypage_macro.render_mypage_grid_item(item, TYPE_ARTWORKS, loop.index) }}
              {% elseif user.type == USER_TYPE_PLACE_OWNER %}
                {{ mypage_macro.render_mypage_place_item(item) }}
              {% endif %}
            {% else %}
              {# 나의 공간을 표시해야하는게 아닌 경우 공통 디자인의 아이템을 사용 #}
              {{ mypage_macro.render_mypage_grid_item(item, pick_type, loop.index) }}
            {% endif %}
          {% endfor %}
        </ul>
        <!-- //== 아이템 목록 -->
      </div>
    </div>
    <!-- //== 작품 또는 장소 아이템 -->
  {% else %}
    <!-- == 아이템 없음 -->
    <div class="itemEmpty">
      <div class="container">
        {% if (user.type == USER_TYPE_ARTIST) or (pick_type == TYPE_ARTWORKS) %}
          <p class="empty">아직 작품이 없습니다 :)</p>
          {% if pick_type is null %}
            <a href="/artworks/upload">작품 등록하러 가기 <i class="glyphicon glyphicon-menu-right"></i></a>
          {% endif %}
        {% else %}
          <p class="empty">아직 공간이 없습니다 :)</p>
          {% if pick_type is null %}
            <a href="/places/upload">장소 등록하러 가기 <i class="glyphicon glyphicon-menu-right"></i></a>
          {% endif %}
        {% endif %}
      </div>
    </div>
    <!-- == 아이템 없음 -->
  {% endif %}

  {# TODO: 비밀번호 변경 및 프로필 이미지 관련 모달 디자인 진행중, 시안 나오면 바로 작업할 예정 #}
  <div class="modal fade" id="profile_modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
              aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">프로필 이미지 변경</h4>
        </div>
        <div class="modal-body">
          <form id="profile_change_form" class="ui form" method="POST" enctype="multipart/form-data"
                action="/api/users/update/image">
            <div class="field">
              <div class="ui">
                <label>사진 선택</label>
                {% if user.profile_image %}현재 사진 {{ user.profile_image }}{% endif %}
                <input type="file" name="profile_image" tabindex="0">
              </div>
            </div>
          </form>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="profile_submit">Save changes</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div class="modal fade" id="password_modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
              aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">비밀번호 변경</h4>
        </div>
        <div class="modal-body">
          <form id="password_change_form" class="ui form" method="POST">
            <div class="field">
              <div class="ui">
                <label>기존 비밀번호 입력</label>
                <input type="password" name="current_password" tabindex="0">
              </div>
            </div>
            <div class="field">
              <div class="ui">
                <label>새로운 비밀번호 입력</label>
                <input type="password" name="new_password" tabindex="0">
              </div>
            </div>
          </form>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="password_submit">Save changes</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
{% endblock %}
